<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.springboot.mapper.OrdersMapper">

    <resultMap id="OrdersResultMap" type="com.example.springboot.entity.Orders">
        <id column="orderid" property="orderid"/>
        <result column="bikeid" property="bikeid"/>
        <result column="userid" property="userid"/>
        <result column="start_time" property="startTime"/>
        <result column="end_time" property="endTime"/>
        <result column="start_lat" property="startLat"/>
        <result column="start_lon" property="startLon"/>
        <result column="end_lat" property="endLat"/>
        <result column="end_lon" property="endLon"/>
        <result column="distance_m" property="distanceM"/>
        <result column="cost" property="cost"/>
        <result column="start_geohash" property="startGeohash"/>
        <result column="end_geohash" property="endGeohash"/>
        <result column="start_weekday" property="startWeekday"/>
        <result column="start_hour" property="startHour"/>
        <result column="is_weekend" property="isWeekend"/>
        <result column="duration_minutes" property="durationMinutes"/>
    </resultMap>

    <insert id="insert">
        INSERT INTO orders (
            orderid,  bikeid, userid, start_time, start_lat, start_lon, start_geohash, start_weekday, start_hour, is_weekend
        ) VALUES (
            #{orderid},
            #{bikeid}, #{userid}, #{startTime}, #{startLat}, #{startLon}, #{startGeohash}, #{startWeekday}, #{startHour},
            #{isWeekend}
        )
    </insert>

    <update id="update">
        UPDATE orders
        SET
            end_time = #{endTime},
            end_lat = #{endLat},
            end_lon = #{endLon},
            distance_m = #{distanceM},
            cost = #{cost},
            end_geohash = #{endGeohash},
            duration_minutes = #{durationMinutes}
        WHERE orderid = #{orderid}
    </update>

    <select id="findActiveOrderByUserAndBike" resultMap="OrdersResultMap">
        SELECT
            orderid, bikeid, userid, start_time, end_time, start_lat, start_lon, end_lat, end_lon,
            distance_m, cost, start_geohash, end_geohash, start_weekday, start_hour, is_weekend, duration_minutes
        FROM orders
        WHERE userid = #{userid} AND bikeid = #{bikeid} AND end_time IS NULL
        LIMIT 1
    </select>

    <select id="findByOrderId" resultMap="OrdersResultMap">
        SELECT
            orderid, bikeid, userid, start_time, end_time, start_lat, start_lon, end_lat, end_lon,
            distance_m, cost, start_geohash, end_geohash, start_weekday, start_hour, is_weekend, duration_minutes
        FROM orders
        WHERE orderid = #{orderid}
        LIMIT 1
    </select>

</mapper>